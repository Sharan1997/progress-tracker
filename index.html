<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Progress Tracker</title>
  <style>
    /* Your existing styles remain unchanged, only the relevant additions are reflected */
    * { transition: all 0.3s ease; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif; margin: 0; padding: 20px;
      background: linear-gradient(to bottom right, #f0f4f8, #e8f5e9);
    }
    .container {
      max-width: 700px; margin: auto; background: #fff;
      padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center; font-size: 32px; color: #2c3e50;
      text-transform: uppercase; letter-spacing: 1.5px;
      margin-bottom: 20px; border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px; font-weight: 700;
    }
    label { display: block; margin-top: 10px; }
    .tasks { margin-top: 20px; }
    .tasks label {
      display: flex; align-items: center;
      margin-bottom: 10px; font-size: 16px;
    }
    input[type="checkbox"] {
      width: 18px; height: 18px; margin-right: 10px;
    }
    .buttons { margin-top: 20px; text-align: center; }
    .buttons button {
      margin: 5px; padding: 10px 20px; font-size: 16px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    .buttons button:hover {
      opacity: 0.9; transform: scale(1.02);
    }
    .save-btn { background-color: #4CAF50; color: white; }
    .clear-btn { background-color: #f44336; color: white; }
    .message {
      text-align: center; margin-top: 10px;
      color: green; font-weight: bold;
    }
    .congrats-message {
      text-align: center; color: #4CAF50;
      font-size: 18px; font-weight: bold; margin-top: 10px;
    }
    select {
      width: 60%; padding: 8px; font-size: 16px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 5px; background-color: #fff;
    }
    textarea {
      width: 100%; margin-top: 10px; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
      font-size: 14px;
    }
    .grid-view { margin-top: 30px; }
    .day-block {
      background: #f9f9f9; border: 1px solid #ddd;
      border-radius: 6px; padding: 15px; margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .entry-row {
      display: flex; justify-content: space-between;
      border-top: 1px solid #ccc; padding: 10px 0;
      flex-wrap: wrap;
    }
    .entry-column {
      flex: 1; padding: 0 10px;
    }
    .task-status span {
      display: inline-block; margin: 4px; padding: 6px 10px;
      border-radius: 20px; font-size: 14px; font-weight: bold;
    }
    .done {
      background-color: #c8e6c9; color: #1b5e20;
      border: 1px solid #a5d6a7;
    }
    .not-done {
      background-color: #ffcdd2; color: #b71c1c;
      border: 1px solid #ef9a9a;
    }
    .date-header {
      font-weight: bold; margin-top: 20px;
      border-bottom: 1px solid #000; padding-bottom: 5px;
      font-size: 18px;
    }
    .entry-column h4 {
      background-color: #e0f7fa; padding: 6px 10px;
      border-radius: 4px; font-size: 16px; font-weight: bold;
      color: #00796b; text-align: center; margin: 0 0 10px 0;
      border: 1px solid #b2dfdb; text-transform: uppercase;
    }
    .progress-bar-container {
      background-color: #eee; border-radius: 5px;
      height: 12px; margin-bottom: 10px; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background-color: #4CAF50;
      transition: width 0.4s ease-in-out;
    }
    .progress-label {
      font-size: 13px; text-align: right;
      margin-bottom: 4px; color: #555; font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Daily Progress Tracker</h1>

    <label for="user">Select User:</label>
    <select id="user" onchange="bindTodayCheckboxes()">
      <option value="">-- Choose User --</option>
      <option value="Nagaveni">👩 Nagaveni</option>
      <option value="Sharan">👨 Sharan</option>
    </select>

    <div class="tasks">
      <label><input type="checkbox" value="Skin Care"> Skin Care</label>
      <label><input type="checkbox" value="Workout"> Workout</label>
      <label><input type="checkbox" value="Dry Fruits"> Dry Fruits</label>
      <label><input type="checkbox" value="Read 30 min"> Read 30 min</label>

      <label for="notes" style="margin-top: 15px;">Optional Note:</label>
      <textarea id="notes" rows="3" placeholder="Write a quick note or comment..."></textarea>
    </div>

    <div class="buttons">
      <button class="save-btn" onclick="saveProgress()">Save Progress</button>
      <button class="clear-btn" onclick="clearCheckboxes()">Clear Response</button>
    </div>

    <div class="message" id="message"></div>
    <div class="congrats-message" id="congrats"></div>
    <div class="grid-view" id="entries"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAETAhm9M3TEyHt-Nfzm9LO1IuiuiNkoEE",
      authDomain: "dailyprogresstracker-3e78d.firebaseapp.com",
      projectId: "dailyprogresstracker-3e78d",
      storageBucket: "dailyprogresstracker-3e78d.appspot.com",
      messagingSenderId: "562711084610",
      appId: "1:562711084610:web:2f99d09be9c35300b777db"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const allTasks = Array.from(document.querySelectorAll('.tasks input[type="checkbox"]')).map(cb => cb.value);

    function getLocalDate() {
      const offset = new Date().getTimezoneOffset() * 60000;
      return new Date(Date.now() - offset).toISOString().split("T")[0];
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const day = date.getDate();
      const suffix = (d => {
        if (d > 3 && d < 21) return 'th';
        switch (d % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      })(day);
      const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      return `${day}${suffix} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
    }

    function bindTodayCheckboxes() {
      const user = document.getElementById('user').value;
      const checkboxes = document.querySelectorAll('.tasks input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      document.getElementById('message').innerText = '';
      document.getElementById('congrats').style.display = "none";
      document.getElementById('notes').value = '';

      if (!user) return;

      const today = getLocalDate();
      const key = `${user}_${today}`;

      // Try localStorage first (optional)
      const entry = localStorage.getItem(key);
      if (entry) {
        const data = JSON.parse(entry);
        checkboxes.forEach(cb => {
          cb.checked = data.tasks.includes(cb.value);
        });
        document.getElementById('notes').value = data.note || '';
        return;
      }

      // Else load from Firestore
      db.collection("progress").doc(key).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          checkboxes.forEach(cb => {
            cb.checked = data.tasks.includes(cb.value);
          });
          document.getElementById('notes').value = data.note || '';
        }
      }).catch(console.error);
    }

    function saveProgress() {
      const user = document.getElementById('user').value;
      const congratsDiv = document.getElementById('congrats');
      congratsDiv.style.display = "none";

      if (!user) return alert("Please select a user");

      const checkboxes = document.querySelectorAll('.tasks input[type="checkbox"]');
      const selectedTasks = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      const note = document.getElementById('notes').value.trim();
      const today = getLocalDate();
      const key = `${user}_${today}`;
      const data = { user, date: today, tasks: selectedTasks, note };

      // Save to localStorage (optional offline fallback)
      localStorage.setItem(key, JSON.stringify(data));

      // Save to Firestore
      db.collection("progress").doc(key).set(data).then(() => {
        document.getElementById('message').innerText = "✅ Today's progress saved!";
        loadEntries();
        if (selectedTasks.length === allTasks.length) {
          congratsDiv.innerText = `🎉 Congratulations ${user}, you did it!`;
          congratsDiv.style.display = "block";
        }
      }).catch(err => {
        console.error("Firestore save error:", err);
        document.getElementById('message').innerText = "❌ Error saving progress!";
      });
    }

    function clearCheckboxes() {
      document.querySelectorAll('.tasks input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.getElementById('notes').value = '';
      document.getElementById('message').innerText = "☑️ Selections cleared!";
      document.getElementById('congrats').style.display = "none";
    }

    async function loadEntries() {
      const entriesDiv = document.getElementById('entries');
      entriesDiv.innerHTML = '';
      const users = ['Nagaveni', 'Sharan'];
      const dataByDate = {};

      try {
        const snapshot = await db.collection("progress").get();
        snapshot.forEach(doc => {
          const data = doc.data();
          const user = data.user;
          const date = data.date;
          if (users.includes(user)) {
            if (!dataByDate[date]) dataByDate[date] = {};
            dataByDate[date][user] = data;
          }
        });

        const renderTasks = userData =>
          allTasks.map(task =>
            `<span class="${userData.tasks.includes(task) ? 'done' : 'not-done'}">
              ${userData.tasks.includes(task) ? '✔️' : '❌'} ${task}
            </span>`
          ).join('<br>');

        const renderProgress = userData => {
          const percent = Math.round((userData.tasks.length / allTasks.length) * 100);
          return `
            <div class="progress-label">${percent}% Complete</div>
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: ${percent}%;"></div>
            </div>
          `;
        };

        // Sort dates descending
        const dates = Object.keys(dataByDate).sort((a,b) => new Date(b) - new Date(a));

        dates.forEach(date => {
          const dayBlock = document.createElement('div');
          dayBlock.className = 'day-block';

          const dateHeader = document.createElement('div');
          dateHeader.className = 'date-header';
          dateHeader.textContent = formatDate(date);
          dayBlock.appendChild(dateHeader);

          const entryRow = document.createElement('div');
          entryRow.className = 'entry-row';

          users.forEach(user => {
            const userData = dataByDate[date][user];
            const col = document.createElement('div');
            col.className = 'entry-column';

            const userTitle = document.createElement('h4');
            userTitle.textContent = user;
            col.appendChild(userTitle);

            if (userData) {
              const taskDiv = document.createElement('div');
              taskDiv.className = 'task-status';
              taskDiv.innerHTML = renderTasks(userData);
              col.appendChild(taskDiv);

              col.innerHTML += renderProgress(userData);

              if (userData.note) {
                const noteDiv = document.createElement('div');
                noteDiv.style.marginTop = '6px';
                noteDiv.style.fontStyle = 'italic';
                noteDiv.style.color = '#555';
                noteDiv.textContent = 'Note: ' + userData.note;
                col.appendChild(noteDiv);
              }
            } else {
              col.innerHTML += `<em>No data</em>`;
            }

            entryRow.appendChild(col);
          });

          dayBlock.appendChild(entryRow);
          entriesDiv.appendChild(dayBlock);
        });
      } catch (error) {
        console.error("Error loading entries:", error);
        entriesDiv.innerHTML = '<p style="color:red; text-align:center;">Error loading progress data.</p>';
      }
    }

    window.onload = () => {
      loadEntries();
    }
  </script>
</body>
</html>
